const e={validation:[{value:"merchantCode",errorMessageEmpty:"MerchanCode empty.",errorMessage:"Invalid merchant code. It must be numeric. It must contain a minimum of 7 and a maximum of 15 characters.",maxLength:15,minLength:7,type:"numeric"},{value:"numberReferenceTrade",errorMessageEmpty:"Number Reference Trade.",errorMessage:"Invalid reference number. Must contain a minimum of 7 and a maximum of 15 characters.",maxLength:15,minLength:7,regex:/^[a-z0-9]+$/i,type:"alphanumeric"},{value:"action",errorMessageEmpty:"Action empty.",errorMessage:"Invalid action, the allowed actions are Pay and Register.",type:"string",includes:["Pay","Register","pay","register"]},{value:"amount",errorMessageEmpty:"Amount empty.",errorMessage:"Invalid amount, the amount must contain two decimal places and be numeric.",type:"decimal"},{value:"codMoney",errorMessageEmpty:"CodeMoney empty.",errorMessage:"Invalid Currency Code. The allowed codes are PEN.",type:"string",includes:["PEN"]},{value:"urlRedirect",errorMessageEmpty:"URL empty.",errorMessage:"Invalid url. Please enter a valid url.",type:"alphanumeric",regex:/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i},{value:"orderNumber",errorMessageEmpty:"OrderNumber empty.",errorMessage:"Invalid Order Number. It must contain a minimum of 5 and a maximum of 12 characters.",type:"alphanumeric",regex:/^[a-z0-9]+$/i,maxLength:12,minLength:5},{value:"mode",errorMessageEmpty:"Mode empty.",errorMessage:"Invalid form upload mode. The allowed modes are dev, test and prod.",type:"string",includes:["dev","test","prod"]}]},t=(e,t,r)=>e.length>=r&&e.length<=t,r=document.createElement("div");r.setAttribute("id","iframe-popup"),r.style.cssText="position: fixed;inset: 0px;overflow: hidden;outline: 0px;background-color: #0a0a0a9e;z-index: 999;opacity: 1;max-width: 100%;height: auto;width: 100% !important;display: flex;justify-content: center;padding: 2rem;";const o=e=>{throw new Error(`${e} is a required attribute for de object "config".`)};class n{constructor(r=o("config")){if(!(this instanceof n))return new n(r);this.config=function({merchantCode:e=o("merchantCode"),numberReferenceTrade:t=o("numberReferenceTrade"),action:r=o("action"),amount:n=o("amount"),codMoney:i=o("codMoney"),billing:a={firstName:void 0,lastName:void 0,motherLastName:void 0,address:void 0,postalCode:void 0,city:void 0,country:void 0,state:void 0,phoneNumber:void 0,email:void 0},urlRedirect:s=o("urlRedirect"),urlIPN:c,render:d=o("render"),orderNumber:m=o("orderNumber"),publicKey:u=o("publicKey"),mode:l=o("mode"),userOrg:p="",userScoring:g="",tokenSession:h=o("tokenSession")}={}){return{merchantCode:e,numberReferenceTrade:t,action:r,amount:n,codMoney:i,billing:a,urlRedirect:s,urlIPN:c,render:d,orderNumber:m,publicKey:u,mode:l,userOrg:p,userScoring:g,tokenSession:h}}(r);const i=(r=>{let o=[];return Object.entries(r).map((([r,n]=entry)=>{const i=e.validation.find((e=>e.value===r));if(i)if(n){if((i.maxLength||i.minLength)&&(t(n.toString()?.trim(),i.maxLength,i.minLength)||o.push(i.errorMessage)),"numeric"===i.type){const e=Number(n);Number.isInteger(e)||o.push(i.errorMessage)}"alphanumeric"===i.type&&(i.regex.test(n)||o.push(i.errorMessage)),"decimal"===i.type&&2!=String(n).split(".")[1]?.length&&o.push(i.errorMessage),"string"===i.type&&(i.includes.includes(n)||o.push(i.errorMessage))}else o.push(i.errorMessageEmpty)})),o})(this.config);if(0!==i.length)throw new Error(i);this._consts=Object.freeze({CURRENT_HOST:window.location.hostname,CURRENT_PROTOCOL:window.location.protocol.toString().replace(":",""),CURRENT_USER_AGENT:window.navigator.userAgent||null,DEFAULT_HOST:"api.izipay.pe",DEFAULT_PORT:"443",DEFAULT_BASE_PATH:"/v1/",DEFAULT_API_VERSION:"1.0",DEFAULT_PROTOCOL:"https",DEFAULT_TIMEOUT:8e4,ALLOWED_CONFIG_PROPERTIES:Object.keys(this.config),_storage:"CSCOBRO.IZIPAY.PE"}),this._initValidation()}_initValidation(){if(!(this instanceof n))return new n(this.config);this._getPropsFromConfig(this.config)}async LoadForm(e,t){if(!e)return o("keyRSA");if("pop-up"!==this.config.render.typeForm&&"embebido"!==this.config.render.typeForm&&"redirect"!==this.config.render.typeForm)throw new Error(`the form type ${this.config.render.typeForm} is not allowed.`);{let t=1e3*(new Date).getTime(),o=(()=>{for(var e=window.localStorage.getItem("transactions")?JSON.parse(window.localStorage.getItem("transactions")):[];e.length<5e4;){for(var t=Math.ceil(5e4*Math.random()),r=!1,o=0;o<e.length;o++)if(e[o]===t){r=!0;break}if(!r)return e[e.length]=t,window.localStorage.setItem("transactions",JSON.stringify(e)),t.toString()}})();const n={requestSource:"RECURRENCE",merchantCode:this.config.merchantCode,publicKey:this.config.publicKey,amount:this.config.amount,orderNumber:this.config.orderNumber,transactionId:o};let i=await(async e=>await fetch("https://testcheckout.izipay.pe/apidemo/v1/Token/Generate",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",transactionId:e.transactionId},body:JSON.stringify(e)}).then((e=>e.json())).then((e=>e)).catch((e=>{console.log("err =>",e)})))(n);if("00"!==i.code)throw new Error(`${i.message}.`);{this.config.tokenSession=i&&i.response.token,this.config.userOrg=i&&i.response.userOrg,this.config.userScoring=i&&i.response.userScoring,this.config.numberReferenceTrade=o,this.keyRSA=e;const n=this.config.render.typeForm,a=((e,t)=>{const r=CryptoJS.lib.WordArray.random(16),o=CryptoJS.PBKDF2(t,r,{keySize:8,iterations:100}),n=CryptoJS.lib.WordArray.random(16),i=CryptoJS.AES.encrypt(e,o,{iv:n,padding:CryptoJS.pad.Pkcs7,mode:CryptoJS.mode.CBC});return r.toString()+n.toString()+i.toString()})(JSON.stringify({publicKey:this.config.tokenSession,config:this.config}).toString(),t.toString());let s="";s="dev"===this.config.mode?"http://localhost:3001":"test"===this.config.mode?"https://testrecurrentes.izipay.pe":"https://recurrentes.izipay.pe:9443";const c=`${s}/pre-affiliation/ecommerce/${this.config.action}/1a88bdf4-9cab-4221-86cb-42b4b102629b?source=${a}&cid=${t.toString()}`;if("pop-up"===n||"embebido"===n){"pop-up"===n&&window.scrollTo({top:0,behavior:"smooth"}),"pop-up"===n&&r.setAttribute("id",this.config.render.container),"pop-up"===n&&document.body.appendChild(r);((e,t)=>{const r=document.querySelector("#"+e);if(!r)throw new Error(`El selector ${e} no existe, asegÃºrese de escribir el nombre correctamente o de que el elemento existe en el DOM`);r.style.height="auto";let o=null;r.querySelector("#paymentIframe")?o=r.querySelector("#paymentIframe"):(o=document.createElement("iframe"),o.id="paymentIframe",o.name="paymentIframe"),o.src=t,o.width="body"!==e?"550px":"100%",o.height="body"!==e?"550px":"100%",o.frameBorder="0",o.scrolling="0",o.style.border="none",o.style.background=e==="#"+e?"transparent":"white",o.style.position="body"===e?"absolute":"relative","body"===e&&(o.style.top="0",o.style.bottom="0",o.style.left="0",o.style.right="0"),r.appendChild(o)})(this.config.render.container,c)}"redirect"===n&&window.location.replace(c)}}}_getPropsFromConfig(e){if(!e)return{};const t="string"==typeof e;if(!(e===Object(e)&&!Array.isArray(e))&&!t)throw new Error("Config must either be an object or a string");const r=Object.keys(e).filter((e=>!this._consts.ALLOWED_CONFIG_PROPERTIES.includes(e)));if(r.length>0)throw new Error(`\n                - The properties: "${r.join(", ")}" are not supported in the Config object Config. \n                - Config object may only contain the following: ${this._consts.ALLOWED_CONFIG_PROPERTIES.join(", ")}`);return e}}window.IzipayCommerce=n||{};
